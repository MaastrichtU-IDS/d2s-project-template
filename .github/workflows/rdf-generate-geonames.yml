name: Generate GeoNames RDF using RML

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  download-input:
    runs-on: ubuntu-latest
    steps: 
    - name: Download CSV
      run: |
        wget https://raw.githubusercontent.com/MaastrichtU-IDS/UM_KEN4256_KnowledgeGraphs/master/dataset-geonames-countryInfo.csv
    - name: Upload CSV input artifact
      uses: actions/upload-artifact@v1
      with:
        name: input
        path: dataset-geonames-countryInfo.csv

  generate-rdf:
    runs-on: ubuntu-latest
    needs: download-input
    outputs:
      rdf-output: ${{ steps.stepupload.outputs.rdf_output }}
    #   output2: ${{ steps.step2.outputs.test }}

    steps:
    - uses: actions/checkout@v2

    - name: Get CSV input artifact
      uses: actions/download-artifact@v1
      with:
        name: input

    - uses: vemonet/rmlmapper-java@4.8
      with:
        mapping: datasets/geonames/mapping/country_mapping.rml.ttl
        output: rdf_output.nq

    - name: Upload RDF output artifact
      id: stepupload
      uses: actions/upload-artifact@v1
      with:
        name: rdf-output
        path: rdf_output.nq

  upload-rdf:
    runs-on: ubuntu-latest
    needs: generate-rdf
    
    steps:
    - uses: actions/checkout@v2

    - name: Get RDF output artifact
      uses: actions/download-artifact@v1
      with:
        name: rdf-output

    - name: Connect to VPN
      run: |
        sudo apt-get install -y openconnect network-manager-openconnect
        echo '${{ secrets.VPN_PASSWORD }}' | sudo openconnect --passwd-on-stdin --authgroup ${{ secrets.VPN_GROUP }} --user ${{ secrets.VPN_USER }} ${{ secrets.VPN_URL }}

    - name: Copy file via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_URL }}
        username: ${{ secrets.SERVER_USER }}
        # port: ${{ secrets.SERVER_PORT }}
        key: ${{ secrets.GITHUB_KEY }}
        source: "rdf_output.nq"
        target: "/data/graphdb-import"
      # ${{needs.generate-rdf.outputs.rdf_output}}
    
    - name: Start GraphDB import
      run: |
        curl -X POST -u ${{ secrets.GRAPHDB_USER }}:${{ secrets.GRAPHDB_PASSWORD }} --header 'Content-Type: application/json' --header 'Accept: application/json' -d '{"fileNames": ["rdf_output.nq"]}' '${{ secrets.GRAPHDB_URL }}/rest/data/import/server/geoeconomics'"
